{
    # Global options block. Entirely optional, https is on by default
    # Optional email key for lets encrypt
    email tamerlanium@gmail.com
    # Optional staging lets encrypt for testing. Comment out for production.
    # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
}

# VPN Admin Panel (service.foodshare.club)
service.foodshare.club {
    # TLS configuration with Cloudflare DNS validation
#    tls {
#        dns cloudflare {env.CLOUDFLARE_API_TOKEN}
#    }

    # Proper headers without browsing-topics
    header {
        # Remove Permissions-Policy browsing-topics to avoid warnings
        Permissions-Policy "accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=(), clipboard-write=(), gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()"
        
        # Security headers
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        Referrer-Policy "strict-origin-when-cross-origin"
        
        # Disable caching for admin panel assets to prevent stale resources
        Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate"
        Pragma "no-cache"
        Expires "0"
    }

    # Special handling for admin panel assets
    @assets {
        path */assets/* */assets/css/* */assets/js/* */assets/vue/* */assets/moment/* */assets/ant-design-vue/* */assets/axios/*
    }

    # Direct assets to 3x-ui server without path rewriting
    handle @assets {
        reverse_proxy 3x-ui:54321 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Proxy to 3x-ui admin panel with proper path handling
    handle_path /BXv8SI7gBe* {
        reverse_proxy 3x-ui:54321
    }

    # Proxy to XRay services
    handle {
        reverse_proxy 3x-ui:2053 {
            # Support WebSocket
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up Upgrade {http.request.header.Upgrade}
            header_up Connection {http.request.header.Connection}
        }
    }

    # Log configuration
    log {
        output file /data/logs/service.foodshare.club.log {
            roll_size 10mb
            roll_keep 5
            roll_keep_for 720h
        }
    }
}

n8n.foodshare.club {
    encode zstd gzip
    reverse_proxy n8n:5678 {
      flush_interval -1
    }
    header {
        # enable HSTS
        Strict-Transport-Security max-age=31536000;
        # disable clients from sniffing the media type
        X-Content-Type-Options nosniff
        # clickjacking protection
        X-Frame-Options DENY
        # keep referrer data off of HTTP connections
        Referrer-Policy no-referrer-when-downgrade
        # Content-Security-Policy: default-src 'self'
    }
}

www.n8n.foodshare.club {
    redir https://n8n.foodshare.club{uri}
}

vpnuk.foodshare.club {
    encode zstd gzip
    reverse_proxy wg-easy:51821
    header {
        # enable HSTS
        Strict-Transport-Security max-age=31536000;
        # disable clients from sniffing the media type
        X-Content-Type-Options nosniff
        # clickjacking protection
        X-Frame-Options DENY
        # keep referrer data off of HTTP connections
        Referrer-Policy no-referrer-when-downgrade
        # Content-Security-Policy: default-src 'self'
    }
}

www.vpnuk.foodshare.club {
    redir https://vpn.foodshare.club{uri}
}

uptime-kuma.foodshare.club {
    encode zstd gzip
    reverse_proxy uptime-kuma:3001
    header {
        # enable HSTS
        Strict-Transport-Security max-age=31536000;
        # disable clients from sniffing the media type
        X-Content-Type-Options nosniff
        # clickjacking protection
        X-Frame-Options DENY
        # keep referrer data off of HTTP connections
        Referrer-Policy no-referrer-when-downgrade
        # Content-Security-Policy: default-src 'self'
    }
}

www.uptime-kuma.foodshare.club {
    redir https://uptime-kuma.foodshare.club{uri}
}

prometheus.mesto.co {
    encode zstd gzip
    reverse_proxy prometheus:9090
    header {
        # enable HSTS
        Strict-Transport-Security max-age=31536000;
        # disable clients from sniffing the media type
        X-Content-Type-Options nosniff
        # clickjacking protection
        X-Frame-Options DENY
        # keep referrer data off of HTTP connections
        Referrer-Policy no-referrer-when-downgrade
        # Content-Security-Policy: default-src 'self'
    }
}

www.prometheus.mesto.co {
    redir https://prometheus.mesto.co{uri}
}

grafana.mesto.co {
    encode zstd gzip
    reverse_proxy grafana:3000
    header {
        # enable HSTS
        Strict-Transport-Security max-age=31536000;
        # disable clients from sniffing the media type
        X-Content-Type-Options nosniff
        # clickjacking protection
        X-Frame-Options DENY
        # keep referrer data off of HTTP connections
        Referrer-Policy no-referrer-when-downgrade
        # Content-Security-Policy: default-src 'self'
    }
}

www.grafana.mesto.co {
    redir https://grafana.mesto.co{uri}
}

antscrypt.foodshare.club {
    encode zstd gzip
    reverse_proxy flask_app:5000
    header {
        # enable HSTS
        Strict-Transport-Security max-age=31536000;
        # disable clients from sniffing the media type
        X-Content-Type-Options nosniff
        # clickjacking protection
        X-Frame-Options DENY
        # keep referrer data off of HTTP connections
        Referrer-Policy no-referrer-when-downgrade
        # Content-Security-Policy: default-src 'self'
    }
}

www.antscrypt.foodshare.club {
    redir https://antscrypt.foodshare.club{uri}
}

audiobookshelf.foodshare.club {
    encode zstd gzip

    reverse_proxy audiobookshelf:13378 {
      flush_interval -1
    }

    # Other headers and configurations
    header {
        # enable HSTS
        Strict-Transport-Security max-age=31536000;
        # disable clients from sniffing the media type
        X-Content-Type-Options nosniff
        # clickjacking protection
        X-Frame-Options DENY
        # keep referrer data off of HTTP connections
        Referrer-Policy no-referrer-when-downgrade
        # Content-Security-Policy: default-src 'self'
    }

    # Increase the maximum upload size
    handle_path /upload* {
        request_body {
            max_size 1GB
        }
    }
}

www.audiobookshelf.foodshare.club {
    redir https://audiobookshelf.foodshare.club{uri}
}